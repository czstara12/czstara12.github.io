---
title: æ— çº¿è°ƒè¯•æ€è·¯.md
date: 2021-01-14 17:20:40
categories:
- stm32
tags:
- cubeide
- jlink
- raspberrypi
---

# æ— çº¿ç½‘è¿œç¨‹è°ƒè¯•

æœ‰æ—¶å€™æˆ‘ä»¬ä¸èƒ½ç›´æ¥æ¥è§¦åˆ°ç¡¬ä»¶ ä½†æ˜¯éœ€è¦è¿›è¡Œåœ¨çº¿è°ƒè¯•(æ¯”å¦‚ è¿è¡Œçš„å°è½¦ å¯†å°çš„èˆ±ä½“ç­‰)

æœ¬æ–‡æ—¨åœ¨ç»™å‡ºä¸€ç§è¿œç¨‹ç¡¬ä»¶çš„è°ƒè¯•æ–¹å¼ä»¥åŠé‡åˆ°çš„å‘

~~MDKä¸æ”¯æŒæ­¤æ–¹æ¡ˆçš„è¿œç¨‹è°ƒè¯•~~

åœ¨MDKå¸¸ç”¨çš„è°ƒè¯•å™¨ä¸­ åªæœ‰jlinkæœ‰interfaceçš„é…ç½®æ  å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç¬¬ä¸€ç§æ–¹æ³•

æˆ‘é€‰ç”¨çš„æ˜¯CubeIDE å…¶å†…ç½®çš„è°ƒè¯•æ–¹æ¡ˆæ˜¯arm-none-eabi-gdb å¯ä»¥è¿æ¥åˆ°è¿œç¨‹gdbæœåŠ¡å™¨ å…¶ä»–åŒç±»æ–¹æ¡ˆå‡å¯å‚è€ƒ

<!-- more -->

## éœ€è¦å‡†å¤‡

1. CubeIDE
2. æ ‘è“æ´¾ï¼ˆä»»æ„ï¼‰
3. jlink windowså¥—ä»¶
   [https://www.segger.com/downloads/jlink/JLink_Windows.exe](https://www.segger.com/downloads/jlink/JLink_Windows.exe)
4. jlink linux on ARMå¥—ä»¶ ç»™æ ‘è“æ´¾è£…çš„ [https://www.segger.com/downloads/jlink/JLink_Linux_arm.deb]([SEGGER - The Embedded Experts - Downloads](https://www.segger.com/downloads/jlink/JLink_Linux_arm.deb))
5. stlink ob v2.1 ä¸€å—(æ¨èä½¿ç”¨ å¯ä»¥åˆ·æ¥åˆ·å»)(å¿…é¡»æ˜¯æ­¤ç‰ˆæœ¬ 2.0ç‰ˆæœ¬çš„åˆ·ä¸äº†jlink ob)(ä¹Ÿå¯ç›´æ¥ä½¿ç”¨jlinkæˆå“)

ä»¥ä¸Šå¥—ä»¶å¯»æ‰¾çš„ä½ç½®[https://www.segger.com/downloads/jlink](https://www.segger.com/downloads/jlink)

## å¤§è‡´æµç¨‹

éœ€è¦æå‰å°†st-link obåˆ·æˆj-link ob

å·¥å…·[https://www.segger.com/products/debug-probes/j-link/models/other-j-links/st-link-on-board/]([ST-LINK On-Board](https://www.segger.com/products/debug-probes/j-link/models/other-j-links/st-link-on-board/))

1. ç”µè„‘å®‰è£…jlink windows
2. è¿æ¥è‡³æ ‘è“æ´¾ å®‰è£…jlink linux arm
3. å°†jlinkè¿æ¥è‡³æ ‘è“æ´¾ä¸Š
4. åœ¨ç”µè„‘ä¸Šå¯åŠ¨J-Link GDB Server
5. ç”µè„‘é€‰æ‹©é…ç½®å‚æ•° å¹¶å¤åˆ¶æœ€ä¸‹é¢æ–¹å—é‡Œçš„å‘½ä»¤è¡Œ
   ![image-20210725170208651](../img/image-20210725170208651.png)
6. æ ‘è“æ´¾å‘½ä»¤è¡Œæ‰§è¡ŒJLinkGDBServer + ä½ åˆšæ‰å¤åˆ¶çš„å‚æ•°
   ![image-20210725170238510](../img/image-20210725170238510.png)
7. è°ƒè¯•æ¢å¤´é€‰jlink
   é€‰ä¸­è¿æ¥åˆ°è¿œç¨‹GDBæœåŠ¡å™¨
   ä¸»æœºåæˆ–IPåœ°å€å¡«ä¸Šæ ‘è“æ´¾çš„IPåœ°å€ ç«¯å£ä¸ç”¨å˜
8. ~~ç›®å‰è¿˜æœ‰ç‚¹å°é—®é¢˜ ä¸çŸ¥é“æ˜¯ä»€ä¹ˆå¼•å‘çš„~~
   å¦‚æœä½ å‡ºç°äº†è¿™æ ·çš„å¼¹çª— å¯è§ä¸‹é¢è§£å†³æ–¹æ¡ˆ

![image-20210725170312197](../img/image-20210725170312197.png)

åŸå› æ˜¯å¯èƒ½æ˜¯é€šè®¯é€Ÿç‡è¿‡é«˜ ç¬¬äº”æ­¥é€‰æ‹©å‘½ä»¤è¡Œå‚æ•°æ˜¯è®¾ç½®åˆ°1MHzä»¥ä¸‹ è¿œç¨‹è°ƒè¯•ä¸€åˆ‡æ­£å¸¸(ã€å¤§æ¦‚åŸå› æ˜¯æ¿å­ä¿¡å·çº¿å¸ƒç½®çš„æœ‰å¹²æ‰°æˆ–è€…èŠ¯ç‰‡æ˜¯ä»¿åˆ¶å“)

æ³¨ï¼šæœ‰æ—¶å€™è°ƒè¯•å™¨ç›´æ¥è¿åˆ°ç”µè„‘ä¸Šè°ƒè¯•ä¹Ÿå‘ç”Ÿè¯¥é”™è¯¯

å…·ä½“æŠ¥é”™(MDK5 CubeIDEæŠ¥é”™ä¸ä¸Šæ–‡ç›¸åŒ)

```
* JLink Info: T-bit of XPSR is 0 but should be 1. Changed to 1.
```

æ‰€ä»¥æœ‰ç±»ä¼¼çš„é”™è¯¯å‡å¯æ€€ç–‘é¢‘ç‡æ˜¯å¦è¿‡é«˜

å¦å¤– æ›´æ–°ä¸‹é¢é‡åˆ°çš„å‘çš„è¯¦ç»†æŠ¥é”™

## å‘ä¸€

### stlink gdb serveræ¨¡å¼

æ ‘è“æ´¾ä½¿ç”¨å·¥å…·stlink-tools

```
sudo apt-get install stlink-tools
```

å¼€å¯gdbserver

```
st-util
```

ä¼šæç¤ºç«¯å£å· ä½†æ˜¯CubeIDEè¿ä¸Šåä¼šå‡ºé”™æ–­å¼€

æ³¨ï¼šst-utilæ˜¯stlinké©±åŠ¨è½¯ä»¶çš„å¼€æºç‰ˆæœ¬ å…¶å®˜æ–¹å¯¹åº”å·¥å…·åœ¨å®˜ç½‘ä¸Šåªæä¾›äº†x86(windowså’Œlinux)ç‰ˆ æ²¡æœ‰æä¾›armç‰ˆ å› æ­¤æ— æ³•åœ¨æ ‘è“æ´¾ä¸Šè¿è¡Œ

#### å…·ä½“æŠ¥é”™

![image-20210725170337445](../img/image-20210725170337445.png)

```
Error in final launch sequence:

Failed to execute MI command:
target remote 192.168.1.244:4242

Error message from debugger back end:
Non-stop mode requested, but remote does not support non-stop
Failed to execute MI command:
target remote 192.168.1.244:4242

Error message from debugger back end:
Non-stop mode requested, but remote does not support non-stop
Non-stop mode requested, but remote does not support non-stop
```

###### è®©openAIå¸®äº†å¸®æˆ‘ è¿˜æ²¡è¯• å…ˆè´´åœ¨è¿™é‡Œ

è¿™ä¸ªé”™è¯¯ä¿¡æ¯æ˜¯ä¸GNU Debugger (GDB)çš„**éåœæ­¢æ¨¡å¼**æœ‰å…³ã€‚éåœæ­¢æ¨¡å¼æ˜¯GDBçš„ä¸€é¡¹åŠŸèƒ½ï¼Œå…è®¸æ‚¨åŒæ—¶è°ƒè¯•å¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ï¼Œè€Œä¸ä¼šåœæ­¢å…¶ä»–çº¿ç¨‹æˆ–è¿›ç¨‹çš„æ‰§è¡Œã€‚ä½†æ˜¯ï¼Œæ­¤åŠŸèƒ½éœ€è¦è°ƒè¯•å™¨å’Œç›®æ ‡ç³»ç»Ÿçš„æ”¯æŒã€‚åœ¨æ‚¨çš„æƒ…å†µä¸‹ï¼Œä¼¼ä¹æ‚¨æ­£åœ¨å°è¯•è°ƒè¯•çš„è¿œç¨‹ç³»ç»Ÿä¸æ”¯æŒéåœæ­¢æ¨¡å¼ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‚¨ä¼šçœ‹åˆ°æ­¤é”™è¯¯æ¶ˆæ¯çš„åŸå› ã€‚

è¦è§£å†³æ­¤é—®é¢˜ï¼Œæ‚¨å¯ä»¥å°è¯•åœ¨GDBä¸­ç¦ç”¨éåœæ­¢æ¨¡å¼ï¼Œæ–¹æ³•æ˜¯åœ¨GDBæ§åˆ¶å°ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```
(gdb) set non-stop off
```

è¿™åº”è¯¥ä¼šç¦ç”¨éåœæ­¢æ¨¡å¼ï¼Œå¹¶å…è®¸æ‚¨åœ¨ä¸é‡åˆ°æ­¤é”™è¯¯æ¶ˆæ¯çš„æƒ…å†µä¸‹è°ƒè¯•ç¨‹åºã€‚

å¸Œæœ›è¿™å¯ä»¥å¸®åŠ©ï¼å¦‚æœæ‚¨æœ‰ä»»ä½•å…¶ä»–é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚ ğŸ˜Š

###### æ ‘è“æ´¾ç«¯æŠ¥é”™

```sh
pi@raspberrypi:/ $ st-util 
st-util 1.5.1

2021-01-15T08:07:36 INFO common.c: Loading device parameters....
2021-01-15T08:07:36 INFO common.c: Device connected is: F4 device, id 0x10076413
2021-01-15T08:07:36 INFO common.c: SRAM size: 0x30000 bytes (192 KiB), Flash: 0x100000 bytes (1024 KiB) in pages of 16384 bytes
2021-01-15T08:07:36 INFO gdb-server.c: Chip ID is 00000413, Core ID is  2ba01477.
2021-01-15T08:07:36 INFO gdb-server.c: Listening at *:4242...
2021-01-15T08:08:05 INFO gdb-server.c: Found 6 hw breakpoint registers #æ­¤è¡Œå¼€å§‹
2021-01-15T08:08:05 INFO gdb-server.c: GDB connected.
2021-01-15T08:08:06 ERROR gdb-server.c: cannot recv: -2
```

ä½†æ˜¯ç›´æ¥ç”¨arm-none-eabi-gdbè£¸è¿å¯ä»¥

## å‘äºŒ

### OpenOcdæ¨¡å¼(jlinkæ¨¡å¼)

æ ‘è“æ´¾ä½¿ç”¨å·¥å…·OpenOcd

```
sudo apt-get install openocd
```

å¼€å¯

```
openocd -f /usr/share/openocd/scripts/interface/jlink.cfg -f /usr/share/openocd/scripts/target/stm32f4x.cfg
```

å¤±è´¥(ç›´æ¥æŠ¥é”™)

```
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "jtag". To override use 'transport select <transport>'.
adapter speed: 2000 kHz
adapter_nsrst_delay: 100
jtag_ntrst_delay: 100
none separate
cortex_m reset_config sysresetreq
Info : No device selected, using first device.
Warn : Starting write / read operation (length = 1 / 2 bytes).
Warn : Sent 1 bytes to device.
Warn : Received 2 bytes from device.
Warn : Read 2 bytes from buffer.
Warn : Starting read operation (length = 112 bytes).
Warn : Received 112 bytes from device.
Warn : Read 112 bytes from buffer.
Info : J-Link STLink V21 compiled Aug 12 2019 10:29:20
Warn : Starting write / read operation (length = 1 / 4 bytes).
Warn : Sent 1 bytes to device.
Warn : Received 4 bytes from device.
Warn : Read 4 bytes from buffer.
Warn : Starting write / read operation (length = 1 / 32 bytes).
Warn : Sent 1 bytes to device.
Warn : Received 32 bytes from device.
Warn : Read 32 bytes from buffer.
Warn : Starting write / read operation (length = 1 / 4 bytes).
Warn : Sent 1 bytes to device.
Warn : Received 4 bytes from device.
Warn : Read 4 bytes from buffer.
Info : Hardware version: 1.00
Warn : Starting write / read operation (length = 1 / 256 bytes).
Warn : Sent 1 bytes to device.
Warn : Received 256 bytes from device.
Warn : Read 256 bytes from buffer.
Warn : Starting write / read operation (length = 1 / 8 bytes).
Warn : Sent 1 bytes to device.
Warn : Received 8 bytes from device.
Warn : Read 8 bytes from buffer.
Info : VTarget = 3.300 V
Warn : Starting write / read operation (length = 14 / 76 bytes).
Warn : Sent 14 bytes to device.
Warn : Received 76 bytes from device.
Warn : Read 76 bytes from buffer.
Warn : Starting write / read operation (length = 2 / 4 bytes).
Warn : Sent 2 bytes to device.
Warn : Received 4 bytes from device.
Warn : Read 4 bytes from buffer.
Error: Selected transport is not supported by the device.
```

#### è®©openAIå¸®äº†å¸®æˆ‘

æ‚¨å¥½ï¼æ‚¨æä¾›çš„æ—¥å¿—æ˜¾ç¤ºï¼Œæ‚¨æ­£åœ¨ä½¿ç”¨ Open On-Chip Debugger 0.10.0[1](https://stackoverflow.com/questions/14194813/calling-a-webservice-by-php-error-no-transport-found-or-selected-transport)ã€‚æ ¹æ®æ—¥å¿—ï¼Œæ‚¨çš„è®¾å¤‡è‡ªåŠ¨é€‰æ‹©äº†ç¬¬ä¸€ä¸ªå¯ç”¨çš„ä¼šè¯ä¼ è¾“ â€œjtagâ€ã€‚ä½†æ˜¯ï¼Œæœ€åå‡ºç°äº†é”™è¯¯æç¤ºï¼šâ€œSelected transport is not supported by the deviceâ€ã€‚

è¿™ä¸ªé”™è¯¯æç¤ºæ„å‘³ç€æ‚¨é€‰æ‹©çš„ä¼ è¾“æ–¹å¼ä¸å—è®¾å¤‡æ”¯æŒã€‚æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ â€˜transport select <transport>â€™ å‘½ä»¤æ¥è¦†ç›–è‡ªåŠ¨é€‰æ‹©çš„ä¼ è¾“æ–¹å¼[2](https://openocd.org/doc/html/Debug-Adapter-Configuration.html)ã€‚å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¤Ÿå¸®åŠ©æ‚¨è§£å†³é—®é¢˜ã€‚å¦‚æœæ‚¨æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚ğŸ˜Š

å¯èƒ½æ˜¯å½“æ—¶ç”¨çš„æ˜¯swd æ²¡è¿ä¸Šjtagçš„çº¿ å›å¤´å†è¯•è¯• å¯è¡Œæ€§å¾ˆé«˜

### æ¢ç”¨stlink

```
openocd -f /usr/share/openocd/scripts/interface/stlink-v2-1.cfg -f /usr/share/openocd/scripts/target/stm32f4x.cfg
```

éœ€è¦è¿›è¡Œä»£ç†

![image-20210725170412047](../img/image-20210725170412047.png)

IDEè¿æ¥æœ¬åœ°3333ç«¯å£

å¤±è´¥

IDEæ— æŠ¥é”™ ç›´æ¥æ–­å¼€

æ ‘è“æ´¾æŠ¥é”™

```
pi@raspberrypi:/ $ openocd -f /usr/share/openocd/scripts/interface/stlink-v2-1.cfg -f /usr/share/openocd/scripts/target/stm32f4x.cfg
Open On-Chip Debugger 0.10.0
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
Info : auto-selecting first available session transport "hla_swd". To override use 'transport select <transport>'.
Info : The selected transport took over low-level target control. The results might differ compared to plain JTAG/SWD
adapter speed: 2000 kHz
adapter_nsrst_delay: 100
none separate
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : Unable to match requested speed 2000 kHz, using 1800 kHz
Info : clock speed 1800 kHz
Info : STLINK v2 JTAG v37 API v2 SWIM v26 VID 0x0483 PID 0x374B
Info : using stlink api v2
Info : Target voltage: 3.234714
Info : stm32f4x.cpu: hardware has 6 breakpoints, 4 watchpoints
Info : accepting 'gdb' connection on tcp/3333
Info : device id = 0x10076413
Info : flash size = 1024kbytes
undefined debug reason 7 - target needs reset
Info : rejected 'gdb' connection, no more connections allowed
Info : dropped 'gdb' connection
```

ä½†æ˜¯ç›´æ¥ç”¨arm-none-eabi-gdbè£¸è¿ä¹Ÿå¯ä»¥

##### åˆ†ææ—¥å¿—

æ‚¨å¥½ï¼æ‚¨æä¾›çš„æ—¥å¿—æ˜¾ç¤ºï¼Œæ‚¨æ­£åœ¨ä½¿ç”¨ Open On-Chip Debugger 0.10.0ã€‚æ ¹æ®æ—¥å¿—ï¼Œæ‚¨çš„è®¾å¤‡è‡ªåŠ¨é€‰æ‹©äº†ç¬¬ä¸€ä¸ªå¯ç”¨çš„ä¼šè¯ä¼ è¾“ â€œhla_swdâ€ã€‚ä½†æ˜¯ï¼Œç³»ç»Ÿæ— æ³•åŒ¹é…è¯·æ±‚çš„é€Ÿåº¦ 2000 kHzï¼Œå› æ­¤ä½¿ç”¨äº† 1800 kHzã€‚

æ—¥å¿—ä¸­è¿˜æ˜¾ç¤ºï¼Œæ‚¨çš„è®¾å¤‡ä½¿ç”¨äº† STLINK v2 JTAG v37 API v2 SWIM v26ï¼Œç›®æ ‡ç”µå‹ä¸º 3.234714 Vã€‚stm32f4x.cpu ç¡¬ä»¶å…·æœ‰ 6 ä¸ªæ–­ç‚¹å’Œ 4 ä¸ªç›‘è§†ç‚¹ã€‚

æ­¤å¤–ï¼Œæ—¥å¿—ä¸­è¿˜æ˜¾ç¤ºäº†ä¸€äº›è­¦å‘Šå’Œé”™è¯¯ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œâ€œundefined debug reason 7 - target needs resetâ€ è¡¨ç¤ºç›®æ ‡éœ€è¦é‡ç½®ã€‚â€œrejected â€˜gdbâ€™ connection, no more connections allowedâ€ å’Œ â€œdropped â€˜gdbâ€™ connectionâ€ è¡¨ç¤º gdb è¿æ¥è¢«æ‹’ç»å’Œä¸¢å¼ƒ ã€‚

å¸Œæœ›è¿™äº›ä¿¡æ¯èƒ½å¤Ÿå¸®åŠ©æ‚¨è§£å†³é—®é¢˜ã€‚å¦‚æœæ‚¨æœ‰å…¶ä»–é—®é¢˜ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ã€‚ğŸ˜Š

## é›†æˆç¡¬ä»¶è®¾æƒ³

æ ‘è“æ´¾zero w + åº•æ¿(jlink obæˆ–stlink obåˆ·jlink ob) è¿æ¥åˆ°ç›®æ ‡æ¿ä¸Š

æˆæœ¬å¤§æ¦‚åœ¨ä¸€ç™¾äºŒä¸‰å~~(å¯èƒ½è¿˜è¦ä½ä¸€äº›)~~ä¸­é—´æœ‰ä¸€æ®µæ—¶é—´åˆè´µäº†ã€‚

è¿ä¸ƒå…«ç³Ÿçš„å…¶ä»–æ´¾åº”è¯¥ä¹Ÿå¯ä»¥ç”¨ è¿˜æ›´ä¾¿å®œ

## å…¶ä»–æ–¹æ¡ˆ

å¦å¤–è¿˜æœ‰ä¸¤ç§æ–¹æ¡ˆç¨å¾®æä¸€ä¸‹

### jlinkè‡ªå¸¦æ— çº¿è°ƒè¯•

jlinkå®˜ç½‘ä¸Šæœ‰ä»‹ç»æ— çº¿è°ƒè¯•çš„åŠŸèƒ½ ~~ä¸è¿‡åŸç†å·®ä¸å¤š å°±æ˜¯GDBserverå’Œusbé€ä¼ (ipusb)~~ï¼ˆæˆ‘æ²¡ç”¨è¿‡ ä¸äº†è§£ï¼‰

ä¸è¿‡ä»·æ ¼å¾ˆè´µ ç›—ç‰ˆæ™®é€šç‰ˆçš„æ²¡æœ‰è¿™ç§åŠŸèƒ½

### è‡ªå·±æ“

å¯ä»¥è¯•è¯•ä½¿ç”¨GDBserveræˆ–è€…usbé€ä¼ (ipusb)

ä½¿ç”¨usbé€ä¼ åœ¨æœ¬åœ°è™šæ‹Ÿå‡ºä¸€ä¸ªusbè®¾å¤‡

CUBEIDEåªæ”¯æŒjlinkå’Œstlink å¹¶ä¸æ”¯æŒcmsis-dap

### ç¬¬ä¸‰æ–¹cmsis-dap

å¦‚æ­£ç‚¹åŸå­ é…æœ‰å‘é€å’Œæ¥æ”¶ç«¯ æ— çº¿ä½¿ç”¨esp8266è¿æ¥ ä¸å¼€æº

### å¼€æºæ— çº¿esp8266

https://github.com/thevoidnn/esp8266-wifi-cmsis-dap

### å¼€æºblack magic for esp8266

https://github.com/walmis/blackmagic-espidf

# 